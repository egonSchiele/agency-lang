#!/bin/bash

# ADL - Agent Definition Language Runner
# Usage: ./adl <file.adl>

set -e  # Exit on error

# Check if file argument is provided
if [ -z "$1" ]; then
    echo "Usage: adl <file.adl>"
    exit 1
fi

ADL_FILE="$1"

# Check if file exists
if [ ! -f "$ADL_FILE" ]; then
    echo "Error: File '$ADL_FILE' not found"
    exit 1
fi

# Get the base filename without extension
BASE_NAME=$(basename "$ADL_FILE" .adl)
DIR_NAME=$(dirname "$ADL_FILE")

# Output TypeScript filename
TS_FILE="${DIR_NAME}/${BASE_NAME}.mts"

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

echo "ğŸ”„ Compiling ADL to TypeScript graph..."

# Generate TypeScript from ADL
node "$SCRIPT_DIR/dist/lib/generate-graph-file.js" "$ADL_FILE" "$TS_FILE"

if [ $? -ne 0 ]; then
    echo "âŒ Failed to generate TypeScript"
    exit 1
fi

echo "âœ… Generated $TS_FILE"
echo "ğŸš€ Running generated code..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Run the TypeScript file directly
node "$TS_FILE"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ Done!"
