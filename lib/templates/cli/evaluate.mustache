import { {{{nodeName:string}}}, isInterrupt, approveInterrupt, rejectInterrupt, modifyInterrupt } from "./{{{filename:string}}}";
import { writeFileSync } from "fs";

export async function runEvaluation() {
  {{#hasArgs}}
  let result = await {{{nodeName:string}}}({{{args?:string}}});
  {{/hasArgs}}
  {{^hasArgs}}
  let result = await {{{nodeName:string}}}();
  {{/hasArgs}}

  {{#hasInterruptHandlers}}
  const interruptHandlers = {{{interruptHandlersJSON?:string}}};
  let handlerIndex = 0;

  while (isInterrupt(result.data)) {
    if (handlerIndex >= interruptHandlers.length) {
      throw new Error("Unexpected interrupt #" + (handlerIndex + 1) + ": \\"" + result.data.data + "\\". No handler provided.");
    }

    const handler = interruptHandlers[handlerIndex];
    const interruptData = result.data;

    // Validate expected message if provided
    if (handler.expectedMessage !== undefined && interruptData.data !== handler.expectedMessage) {
      throw new Error(
        "Interrupt #" + (handlerIndex + 1) + " message mismatch.\\n" +
        "  Expected: \\"" + handler.expectedMessage + "\\"\\n" +
        "  Actual: \\"" + interruptData.data + "\\""
      );
    }

    // Handle interrupt based on action
    if (handler.action === "approve") {
      result = await approveInterrupt(interruptData);
    } else if (handler.action === "reject") {
      result = await rejectInterrupt(interruptData);
    } else if (handler.action === "modify") {
      result = await modifyInterrupt(interruptData, handler.modifiedArgs);
    } else {
      throw new Error("Unknown interrupt action: " + handler.action);
    }

    handlerIndex++;
  }

  // Check if we provided more handlers than interrupts that occurred
  if (handlerIndex < interruptHandlers.length) {
    throw new Error(
      "Expected " + interruptHandlers.length + " interrupts but only " + handlerIndex + " occurred."
    );
  }
  {{/hasInterruptHandlers}}

  writeFileSync("__evaluate.json", JSON.stringify(result, null, 2));
  return result;
}

runEvaluation();