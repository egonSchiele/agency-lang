#!/bin/bash

# agency - Agency Language Runner
# Usage: ./agency <file.agency>

set -e  # Exit on error

# Check if file argument is provided
if [ -z "$1" ]; then
    echo "Usage: agency <file.agency>"
    exit 1
fi

AGENCY_FILE="$1"

# Check if file exists
if [ ! -f "$AGENCY_FILE" ]; then
    echo "Error: File '$AGENCY_FILE' not found"
    exit 1
fi

# Get the base filename without extension
BASE_NAME=$(basename "$AGENCY_FILE" .agency)
DIR_NAME=$(dirname "$AGENCY_FILE")

# Output TypeScript filename
TS_FILE="${DIR_NAME}/${BASE_NAME}.mts"

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

echo "ğŸ”„ Compiling agency to TypeScript graph..."

# Generate TypeScript from agency
node "$SCRIPT_DIR/dist/lib/generate-graph-file.js" "$AGENCY_FILE" "$TS_FILE"

if [ $? -ne 0 ]; then
    echo "âŒ Failed to generate TypeScript"
    exit 1
fi

echo "âœ… Generated $TS_FILE"
echo "ğŸš€ Running generated code..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Run the TypeScript file directly
node "$TS_FILE"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ Done!"
